Подключение устройства к хосту (1)
<Звизда>
![[81.jpg]]
--

Логическая архитектура (2) (Просрал кадр)

-- 

Существует 3 уровня, через которое выполняется взаимодействие с компонентами. 
Со стороны хоста (3):
	1. Клиентское ПО управляет интерфейсом (**Функциональный уровень**)
	2. Системное ПО USB управляет устройством (**Логический уровень**)
	3. Хост-контроллер интерфейса USB (**Уровень шины**)
		3.1 Физический уровень взаимодействия порта USB
		

![[83.jpg]]

**Клиентское ПО**  - отправляет запросы на уровень системного ПО.

**Системное ПО USB** - системный драйвер, который состоит из:
- драйвер шины USB
- драйвер контроллера хоста:
	- принимает от хоста набор транзакций
	- составляет план исполнения транзакций
	- производит выборку транзакций и поочередное выполнение

**Хост-контроллер** - планирует выполнение транзакций, дополняя их к списку (в общий перечень транзакций).

Выполнение транзакций на уровне шины выполняется асинхронно с работой вышестоящих уровней. Данный подход формирует своеобразный *"Паттерн обмена данными по USB"*.

Выполнение запроса:
1. Клиентское ПО формирует запрос
2. Драйвер USB формирует транзакции
3. Драйвер IRP хост-контроллера распределяет транзакции по спискам
4. Хост-контроллер шины формирует кадры
5. Кадры уходят в линию обмена (NRZI, битовая передача)

![[84.jpg]]

Каждая спецификация шины определяет 4 различных типа передачи. Устройств может быть до 127 штук (7-разрядный адрес).

![[85.jpg]]

Типы передач:
1. **Управляющая передачей (control transfer)** - используется хостом для конфигурирования устройства, для управления устройством и получения статусной информации; 
	- гарантирована доставка
	- хост выделяет 10% полосы пропускания
	- длина поля данных не превышает 64 байта
2. **Передача массивов данных (bulk data transfer)** 
	- гарантирована доставка
	- время доставки не ограничено
	- занимает всю доступную полосу пропускания
	- приоритет передачи самый низкий
3. **Передача по прерывания (interrupt transfer)** - используется в случае, когда необходимо передавать одиночные пакеты данных небольшого размера;
	- требует высокой скорости выполнения
	- готовность передавать данные определяется хостом после запроса состояния устройства
	- передача используется как правило в устройствах ввода 
4. **Изохронные передачи** - применяются для обмена данными в реальном времени, когда на каждом интервале необходимо передавать строго определенное количество данных;
	- доставка инфомрации не гарантирована
	- передача без повторения при сбоях
	- занимают предварительно согласованную часть линии пропускания
	- имеют заданную задержку для старта
	- разделяются по типу синхронизации конечных точек

*Таблица "Типы передачи"*
![[86.jpg]]

Все невыполненные передачи хранятся в списках под статусом "Невыполненные" (для каждого типа передачи есть свой список). 

Обслуживание запросов:
1. Наивысший приоритет отводится изохронным операциям
2. Системные операции
3. Передача пакетов
4. Передача массивов данных

Начало каждого кадра SOF - метка начала (для каждого из кадров). Каждый кадр имеет свой номер. 
Номер кадра циклически увеличивается в момент получения метки EOF. 

Конечная точка - часть USB устройства с уникальным идентификатором (буфер, сохраняющий несколько байт).

Конечная точка имеет параметры:
- частота доступа шины
- допустимая величина задержки обслуживания
- допустимая ширина полосы пропускания
- используемый тип посылок
- максимальный размер пакетов для отправки
- направление передачи

**Канал** - логическое соединение между конечной точкой USB-устройства и ПО хоста.

![[87.jpg]]



Существует 2 модели канала:
1. **Потоковый канал (Streaming pipe)** - канал, структура которого определяется клиентским ПО. Передача массивов данных, изохронные передачи, передача пакетов данных. 
	1. То, что формирует драйвер устройства на верхнем уровне,  может выполняться в совершенно разном порядке
	2. Если происходит серьезная ошибка - поток останавливается
2. **Канал сообщений (Message pipe / Control pipe)** - канал передачи данных, структуру которого определяет USB. Запрещает обработку новых сообщений до завершения обработки предыдущего. 

Основные характеристики каналов:
1. Полоса пропускания 
2. Используемый каналом тип передачи данных 
3. Храктеристики соответсвующей конечной точки 
	1. Направление передачи
	2. Максимальный размер пакета 

Канал сообщений, связанный с нулевой конечной точкой - канал по умолчанию. 
Основной канал сообщений поддерживает только потоковые передачи. 

По клиентским каналам могут передаваться как потоки, так и сообщения с любыми типами передач. 

Набор клиентских каналов, с которыми работает драйвер устройства называется **интерфейсом устройства**.

![[88.jpg]]

---

Next door:

