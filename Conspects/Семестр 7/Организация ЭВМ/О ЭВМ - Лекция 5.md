# Архитектура системы команд X86

Команды управления программой (безусловная передача управления)
Ближняя передача - в текущем сегменте (получение смещения).
Дальняя передача - в другом сегменте (для передачи получить ID сегмента + смещение).

**Логический адрес** - используется для адресации в программах. Программа разбивается на сегменты, которые в процессе выполнения загружаются в ОП. Логическая программа разбивается на сегменты кода, стека, данных и другие. Для локализации сегментов в ОП используются сегментные регистры. 

**Линейный адрес** - (линейное адресное пространство) представляет собой множество возможных адресов, формируемых на шине адреса процессора. Разрядность адресной шины определяет диапазон линейных адресов.

**Физический адрес** - выдается в шину адреса (внешнюю шину) для адресации в ОП. Чтобы вынуть информацию из ОП, необходимо передать в ОП адрес запрашиваемых данных, это и есть физический адрес. 

> Лог. адрес -> Устройство сегментации -> Лин. адрес -> Устройство страничной адресации -> Физ. адрес -> ОП

##### Способы адресации операндов

**Неявная адресация** - операнд адресуется неявно, если в команде нет специальных полей для его определения (операнд задается кодом операции). Пример: *std* - установка флага направления

**Регистровая адресация** - операнд находится во внутреннем регистре процессора. Пример: *inc esi* - инкремент esi / *add ai, di* 

**Непосредственная адресация** - операнд находится в самой команде (хранится вместе с командой в сегменте кода).

---
##### Адресация операндов в ОП

**Эффективный адрес** - смещение операнда от начала сегмента. 

**Прямая адресация** - эффективный адрес находится в самой команде. 
EA=DISP(d16/32)
mov AL, DS\[2]

**Косвенно-регистровая адресация** - в регистре хранится адрес объекта.
LA=BASE(BX/EBX)
EA=INDEX(SI/ESI,SI/EDI)
mov AS, DS\[EAX]

**Базовая адресация**
EA=BASE(BX,BP) + DISP(d8,d16)

- Индексная адресация ...
- Базово-индексная адресация ...
- Базово-индексная адресация со смещением ...

**Базово-индексная адресация со смещением и масштабированием** (только в защищенном режиме с 32-разрядной адресацией)
EA=BASE(POH) + INDEX(POH, кроме ESP) \* F + DISP(d32)
inc word ptr\[EBX+10h]\[EAX\*2]

! После переключения процессора в защищенный режим содержимое сегментных регистров будет рассматриваться совсем по-другому.

**Стековая адресация**
SS - stack segment  
SP - stack pointer (запись в стек уменьшение адреса)
PUSH - влкючение в стек
POP - извлечение из стека

Плоская модель памяти - процессор, имеющий n линий в шине адреса может адресоваться к 2^n ячейкам памяти. Программы могут размещаться по адресам 0 - (2^n-1)

---
##### Сегментная модель памяти 
Сегментация - такая организация памяти, при которой используется много независимых линейных адресов пространств, называемых сегментами. 

**Достоинства сегментации:**
- Обеспечение модульности программ
- Придает коду и данным перемещаемость
- Реализация управления виртуальным адресным пространством, защиты памяти, многозадачности

**Причины сегментации:**
- разнородность используемых структурных элементов с данными
- проблема адресации 

**Недостатки сегментации:**
- Сегменты имеют всего 2 атрибута (начальный адрес + максимальный размер 64КБ). Никаких средств контроля правильности использования сегментов нет.
- Размещение сегментов в памяти произвольно. Они могут перекрываться частично, полностью, или не иметь общих связей.
- Программа может обращаться к любому сегменту для записи и считывания данных и для выборки команд. Может нарушить область системных данных.
- Нет никаких препятствий для обращения даже к физически не существующей памяти.

---
Преобразование логического адреса в линейный:
CS (100h) \* IP (08h) = 1000h (100h\*16) + 08h = 1008h

Эффект "закругления" (похоже на кольцевой буфер) - при выходе за максимальный адрес происходит переход к минимальному.

---
##### Сегментация в защищенном режиме

Каждый сегмент характеризуется специальной 8-байтовой структурой данных, называемой десприптором сегмента (описателем сегмента).

> Для 286-го процессора (16-разрядный) 

![[ПАМЯТЬ.png | 500]]

**Базовый адрес** - определяет расположение сегмента в ОП.
**Предел** - указывает на последний адресуемый байт сегмента. 
**G** - бит гранулярности. Определяет единицу измерения поля предел.
**G = 0** (байтная гранулярность)
**G = 1** (страничная гранулярность)
**1 страница** = 4 килобайта = 2^12 байт 

Поле "ТИП" определяет целевое использование сегмента. Включает бит подчиненности + бит разрешения считывания. Благодаря данной организации появляется удобство для защиты программ разработчиками. 

Каждый сегмент характеризуется своим дескриптором. Для дескрипторов существуют хранилища:
- Глобальная дескрипторная таблица (GDT) - хранятся все дескрипторы. 
- Десприпторная таблица прерывания (IDT) - для вызова обработки прерывания и исключений. Располагается в ОП.
- Локальная дескрипторная таблица (LDT) - содержит дескрипторы сегментов, доступных только для одной конкретной задачи. Для локализации используется 16-разрядный регистр LDTR, который косвенно через GDT определяет LDT. 

Контроллер прерываний передает на процессор 8-битный указатель - это 256 возможных значений. 
256 векторов \* 4  = 1 КБайт  - вес одного дескриптора

*Селекторы сегментов* загружаются в сегментные регистры и косвенно через дескрипторные таблицы определяют сегменты. 

---



