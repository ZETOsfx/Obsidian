## The Point-to-Point Protocol (PPP)
#### Обнаружение закольцованных связей
PPP обнаруживает закольцованные связи, использую особенность, включающую Magic Numbers. Когда узел отправляет LCP-сообщения, они могут включать в себя магическое число. Если линия закольцована, узел получает сообщение с его собственным магическим числом вместо другого. 

#### Конфигурирование опции PPP
Так как в РРР входит LCP протокол, то можно управлять следующими LCP-  
параметрами:  
- **Аутентификация**. RFC 1994 описывает Challenge Handshake Authentication Protocol  
(CHAP), который является предпочтительным для проведения аутентификации в  
PPP, хотя Password Authentication Protocol (PAP) иногда еще используется. Др. вариантом для аутентификации является Extensible Authentication Protocol (EAP).  
- **Сжатие**. Эффективно увеличивает пропускную способность РРР соединения за счет сжатия данных в кадре. Наиболее известными алгоритмами сжатия PPP кадров  
являются Stacker и Predictor.  
- **Обнаружение ошибок**. Включает Quality-Protocol и помогает выявить петли обратной связи посредством Magic Numbers RFC 1661.  
- **Многоканальность**. Multilink PPP (MLPPP, MPPP, MLP) предоставляет методы для распространения трафика через несколько физических каналов, имея одно логическое соединение. Этот вариант позволяет расширить пропускную способность.

#### РРР-кадр 
Каждый кадр PPP всегда начинается и завершается байтом 0х7Е. Затем следует байт адреса и байт управления, кот. тоже всегда равны 0xFF и 0х03, соответственно. В связи с вероятностью совпадения байтов внутри блока данных с зарезервированными флагами существует система автоматической корректировки проблемных данных с последующим восстановлением.

| Флаг 0x7E | Адрес 0xFF | Управление 0x03 | Данные | Контрольная сумма | Флаг 0x7E |
| --------- | ---------- | --------------- | ------ | ----------------- | --------- |
| 1         | 1          | 1               | 1494   | 2                 | 1         |

---
#### HDLC и SDLC 
HDLC был разработан на основе протокола SDLC фирмы IBM. Его несильно измененные дочерние протоколы - LAPB, LAPM, LAPF, LAPD были встроены ITU соответственно в стеки протоколов Х.25, V.42, Frame Relay, ISDN. Также HDLC был базой при разработке кадровых механизмов в протоколе РРР, широко используемом в Интернете.  

**Протоколы SDLC** (Synchronous Data Link Control — управление синхронным звеном информации) **и HDLC** (High-level Data Link Control — высокоуровневое управление звеном транспортировки информации) относятся ко второму уровню модели OSI. Они реализуют безошибочную транспортировку данных между узлами сети - данные, вложенные вышестоящим протоколом, точно будут приняты без потерь получателем. Протоколы реализуют связь одного первичного узла с одним или более вторичными узлами.  

Первичный узел реализует функцию опроса вторичных узлов, и если у вторичных узлов есть готовые данные для отправки, первичный разрешает им эту отправку. Свои же данные первичный узел транспортирует когда потребуется. Протоколы реализуют контроль потока данных — транспортировка реализуется только при готовности приемника.  
Протоколы оперируют кадрами (фреймами).

Протокол SDLC есть подмножеством протоколов HDLC, но они имеют различия:  
- Страница 71 из 93  
- HDLC имеет 32-битное поле CRC  HDLC поддерживает только многоточечную и двухточечную конфигурацию SDLC реализует только один механизм передачи (NRM), HDLC же поддерживает следующие:  
	- **NRM** — нормальный режим ответа, вторичные узлы не могут связываться с первичным без получения разрешения  
	- **ARM** — асинхронный режим ответа; вторичные узлы могут создавать связи с первичным узлом без разрешения  
	- **АВМ** — асинхронный симметричный режим; здесь узел может быть комбинированным, что дает ему право быть и первичным и вторичным, в зависимости от ситуации

#### Типы станций
- **Первичная** (ведущая) станция (Primary Terminal) ответственна за управление каналом и восстановление его работоспособности. Она производит кадры команд. В соединениях точка-многоточка поддерживает отдельные связи с каждой из вторичных стан-ций.  
- **Вторичная** (ведомая) станция (Secondary Terminal) работает под контролем ведущей, отвечая на се команды. Поддерживает только 1 сеанс связи.  
- **Комбинированная** станция (Combined Terminal) сочетает в себе функции как ведущей, так и ведомой станций. Производит и команды и ответы. Только соединения точка-точка.

HDLC поддерживает 3 режима логического соединения логического соединения, различающиеся ролями:
- **Режим нормального ответа** (Normal Response Mode, NRM) требует инициации передачи в виде явного разрешения на передачу от первичной станции. После использования канала вторичной станцией (ответа на команду первичной), для продолжения передачи она обязана ждать др. разрешения. Для выбора права на передачу первичная станция проводит круговой опрос вторичных. Используется в основном в соединениях точка-многоточка.  
- **Режим асинхронного ответа** (Asynchronous Response Mode, ARM) дает возможность вторичной станции самой инициировать передачу. В основном используется в соединениях типа кольцо и многоточечных с неизменной цепочкой опроса, так как в этих соединениях одна вторичная станция может получить разрешение на передачу от другой вторичной и в ответ начать передачу. То есть разрешение на передачу передастся по типу маркера (Token). За первичной станцией сохраняются обязанности по инициализации линии, определению ошибок передачи и логическому разъединению. Позволяет уменьшить накладные расходы, связанные с началом передачи.  
- **Асинхронный сбалансированный режим** (Asynchronous Balanced Mode, ABM) используется комбинированными станциями. Передача может быть инициирована с любой стороны, может происходить в полном дуплексе. В режиме АВМ оба устройства.

#### Конфигурация канала
Для обеспечения совместимости между станциями, кот. могут менять свой статус  
(тип), в протоколе HDLC предусмотрены 3 конфигурации канала:  
- **Несбалансированная конфигурация** (UN — Unbalanced Normal) обеспечивает работу 1 первичной и одной или нескольких вторичных станций в (симплексном) полудуплекс-ном и полнодуплексном режимах, с коммутируемым или некоммутируемым каналом.  
- **Симметричная конфигурация** (UA, Unbalanced Asynchronous) обеспечивает взаимодействие 2 двухточечных несбалансированных станций. Используется 1 канал передачи, в который мультиплексируются и команды и ответы. В данное время не используется.
- **Сбалансированная конфигурация** (BA — Balanced Asynchronous) состоит из 2 комбинированных станций. Передача (симплексном) полудуплексном и полнодуплексном режимах, с коммутируемым или некоммутируемым каналом. Каждая станция несет одинаковую ответственность за управление каналом.
#### Кадры
Кадры HDLC можно передавать, используя синхронные и асинхронные соединения. В самих соединениях нет механизмов определения начала и конца кадра, для этих целей используется уникальная в пределах протокола битовая последовательность (FD  
- Frame Delimiter) 01111110 (0×7E в 16-ричном представлении), помещаемая в начало и  
конец каждого кадра. Уникальность флага ґарантируется использованием битстаффинга  
в синхронных соединениях и байтстаффинга в асинхронных. Битстаффинг — вставка би-тов, здесь бита 0 после 5 подряд идущих битов 1. Битстаффинг работает только во время передачи информационного поля (поля данных) кадра. Если передатчик обнаруживает, что передано подряд 5 единиц, то он автоматически вставляет дополнительный ноль в последовательность передаваемых битов (даже если после этих пяти единиц и так идёт ноль). Поэтому последовательность 01111110 никогда не появится в поле данных кадра. Аналогичная схема работает в приемнике и выполняет обратную функцию. Когда после пяти единиц обнаруживается ноль, он автоматически удаляется из поля данных кадра. В байтстаффинге используется Escape-последовательность, здесь — 01111101  
(Ох 7D в 16-ричном представлении), т.е. байт FD (0x7E) в середине кадра заменяется.

#### Типы кадров

- **І-кадры** (информационные кадры, кадры данных) - Предназначены для передачи  
данных пользователя. В процессе передачи информационных блоков осуществляется их нумерация в соответствии с алгоритмом скользящего окна. После установления соединения данные и положительные квитанции начинают передаваться в информационных кадрах. Логический канал HDLC является дуплексным, так что информационные кадры, а значит, и положительные квитанции могут передаваться в обоих направлениях. Если же потока информационных кадров в обратном направлении нет или же нужно передать отрицательную квитанцию, то используются управляющие кадры.  

**S-кадры** (управляющие) — Используются для контроля потока ошибок передачи.  
В управляющих кадрах передаются команды и ответы в контексте установленного логического соединения, в том числе запросы на повторную передачу скаженных информационных блоков.  

**U-кадры** (ненумерованные) — определяются по 2 младшим битам, установленным в 1. Таким образом, вместе с флагом P/F это оставляет 5 бит для типа кадра. Т.к. используется менее 32 значений, некоторые типы кадров имеют разный смысл в зависимости от  
способа отправки: как запрос или как ответ. U-кадры предназначены для установления и разрыва логического соединения, а также информирования об ошибках.

---
## PPPOE  

**PPPoE** (Point-to-Point Protocol over Ethernet)  — сетевой протокол канального уровня  
(2-й уровень сетевой модели OSI) передачи кадров PPP через Ethernet. В основном используется провайдерами для подключения пользователей МКД через Ethernet и xDSL-  
Ethernet. B Ethernet H XDSt - сервисы. Предоставляет доп. возможности (аутентификация, сжатие данных, шифрование).  

Стандартное MTU протокола ниже, чем на стандартном Ethernet (Ethernet - 1500Б;  PPPoE — 1492Б), что иногда вызывает проблемы с плохо настроенными межсетевыми экранами.  

**PPPoE** — это туннелирующий протокол, кот. позволяет настраивать (или инкапсулировать) IP или др. протоколы, кот. настраиваются на РРР, через соединения Ethernet, но с программными возможностями РРР-соединений, и поэтому используется для виртуальных звонков на соседний Ethernet-хост и устанавливает соединение точка точка, кот. используется для транспортировки IP-пакетов, работающее с возможностями  

Это позволяет применять традиционное РРР-ориентированное ПО для настройки соединения, кот. использует не последовательный канал, а пакетно-ориентированную сеть (напр., Ethernet), чтобы организовать классическое соединение с логином, паролем для Интернет-соединений. Также IP-адрес по др. сторону соединения назначается, только когда РРРоЕ-соединение открыто, допуская динамическое переиспользование ІР-адресов.  
PPPoE разработан UUNET, Redback Networks и Router Ware. Протокол описан в RFC  
Стоит отметить, что некоторые поставщики оборудования (Cisco и Juniper, напр.) используют термин **РРРоЕоЕ** (PPPoE over Ethernet), означающий РРРоЕ, работающий напрямую через Ethernet или др. ІЕЕЕ 802.3 сети, а также РРРоЕ, работающий через связанные в Ethernet (Ethernet Bridged over) ATM, для того, чтобы отличать от PPPoA (PPPoE over ATM), кот. работает на ATM Virtual Circuit по спецификации RFC 2684 и SNAP и инкапсулирует PPPoE. PPPoA — это не то же самое, что Point-to-Point Protocol over AIM (PPPoA), поскольку он не использует SNAP.

![[Иваныч такой.jpg | 150]]

Работа PPPoE осуществляется следующим образом. Существует Ethernet-среда, то есть несколько соединенных сетевых адаптеров, кот. адресуются МАС-адресами.  

Заголовки Ethernet-кадров содержат адрес отправителя кадра, адрес получателя кадра и тип кадра. Одну из карт слушает РРРоЕ-сервер. Клиент посылает широковещательный  
Ethernet-кадр, на кот. должен ответить РРРоЕ-сервер (адрес отправителя кадра — свой МАС-адрес, адрес получателя кадра — FF:FF:FF:FF:FF:FF и тип кадра — PPPoE Active Discovery Initiation). PPPoE-сервер посылает клиенту ответ (адрес отправителя кадра - свой МАС-адрес, адрес получателя кадра — МАС-адрес клиента и тип кадра — РРРоЕ Active Discovery Offer). Если в сети несколько РРРоЕ-серверов, то все они посылают ответ. Клиент выбирает подходящий сервер и посылает ему запрос на соединение. Сервер посылает клиенту подтверждение с уникальным идентификатором сессии, все последующие кадры в сессии будут иметь этот идентификатор. Т.о., между сервером и клиентом создается виртуальный канал, кот. идентифицируется идентификатором сессии и МАС-адресами клиента и сервера. Затем в этом канале устанавливается PPP-соединение, а уже в РРР-пакеты упаковывается IP-трафик.

#### Преимущества использования PPPoE  

1. IP-заголовки в Ethernet-среде игнорируются. То есть пользователь может назначить IP-адрес своей сетевой карте, но это не приведет к обвалу сети (теоретически при работе с сетевым концентратором не должно произойти обвала и при смене пользователем МАС-адреса даже на адрес сервера, а при работе с сетевым коммутатором все зависит от конструкции коммутатора)  
2. Каждое соединение отделено от других (работает в своем канале)  
3. Настройки (IP-адрес, адрес шлюза, адреса DNS-серверов) могут передаваться сервером  
4. РРР-соединение легко аутентифицируется и обсчитывается (например, при помощи RADIUS)  
5. РРР-соединение можно шифровать. Напр., при работе с сетевым концентратором (когда на каждом сетевом адаптере может быть виден весь Ethernet-трафик) прочитать чужой IP-трафик весьма затруднительно

---
## PPTP 

**PPTP** (Point-to-Point Tunneling Protocol) - туннельный протокол типа точка-точка, позволяющий компьютеру устанавливать защищенное соединение с сервером за счет создания специального туннеля в стандартной, незащищенной сети. РРТР помещает (инкапсулирует) кадры РРР в IP-пакеты для передачи по глобальной или локальной IP-сети. РРТР может также использоваться для организации туннеля между 2 ЛС. PPTP использует дополнительное ТСР-соединение для обслуживания туннеля.

![[чезСХема.jpg]]

Спецификация протокола была опубликована как информационная RFC 2637 в  
1999г. Она не была ратифицирована IETF. Протокол считается менее безопасным, чем  
IPSec. PPTP работает, устанавливая обычную PPP-сессию с противоположной стороной с помощью протокола Generic Routing Encapsulation (общая инкапсуляция маршрутов протокол туннелирования сетевых пакетов). 2-е соединение на ТСР-порту 1723 используется для инициации и управления GRE-соединением. PPTP сложно перенаправлять за сетевой экран, т.к. он требует одновременного установления 2 сетевых сессий.  

РРТР-трафик может быть зашифрован с помощью МРРЕ. Для аутентификации клиентов могут использоваться различные механизмы, наиболее безопасные из них  
MS-CHAPv2 и EAP-TLS.
#### Реализация PPTP

Cisco первой реализовала РРТР и позже лицензировала эту технологию корпорации  
Microsoft.  

РРТР удалось добиться популярности благодаря тому, что это первый протокол туннелирования, который был поддержан корпорацией Microsoft. Все версии Microsoft Windows, начиная с Windows 95 OSR2, включают в свой состав РРТР-клиент, однако существует ограничение на два одновременных исходящих соединения. А сервис удалённого доступа для Microsoft Windows включает в себя РРТР-сервер.  
Некоторое время в Linux-дистрибутивах отсутствовала полная поддержка РРТР из-за опасения патентных претензий по поводу протокола МРРЕ. Впервые полная поддержка  
MPPE появилась в Linux 2.6.13 (2005г.) Официально поддержка РРТР была начата с версии ядра Linux 2.6.14. Тем не менее, сам факт применения MPPE в РРТР фактически не обеспечивает безопасность протокола PPTP.  

Протокол РРТР поддерживают большинство операционных систем, в т. ч.: MS Windows, UNIX, Linux, Android, iOS и т.д.
#### Безопасность протокола PPTP  

В протоколе РРТР были обнаружены различные серьезные уязвимости. Известные относятся к используемым протоколам аутентификации РРР, устройству протокола MPPE и интеграции между аутентификациями MPPE и PPP для установки сессионного ключа.  
Краткий обзор данных уязвимостей:  
- MSCHAP-v1 совершенно ненадежен. Существуют утилиты для лёгкого извлечения хешей паролей из перехваченного обмена MSCHAP-v1.  
- MSCHAP-v2 уязвим к словарной атаке на перехваченные пакеты Challenge  
Response. Существуют программы, выполняющие данный процесс.  
- В 2012г. было показано, что сложность подбора ключа MSCHAP-v2 эквивалентна подбору ключа к шифрованию DES, и был представлен онлайн-сервис, кот. способен восстановить ключ менее чем за сутки.  
- При использовании MSCHAP-v1, MPPE использует одинаковый RC4 сессионный ключ для шифрования информационного потока в обоих направлениях. Поэтому стандартным методом является выполнение XOR потоков из разных направлений вместе, благодаря чему злоумышленник может узнать ключ.  
- МРРЕ использует RC4 поток для шифрования. Не существует метода для аутентификации цифробуквенного потока и поэтому данный поток уязвим к атаке, делающей подмену битов. Злоумышленник легко может изменить поток при передаче и заменить некоторые биты, чтобы изменить исходящий поток без опасности своего обнаружения. Данная подмена битов может быть обнаружена с помощью протоколов, считающих контрольные суммы.

---
## L2TP  

**L2TP** (Layer 2 Tunneling Protocol  — протокол туннелирования 2-го уровня) в компьютерных сетях туннельный протокол, использующийся для поддержки виртуальных частных сетей (VPN). Главное достоинство L2TP состоит в том, что этот протокол позволяет создавать туннель не только в сетях IP, но и в таких, как АТМ, Х.25 и Frame.
Несмотря на то, что L2TP действует наподобие протокола канального уровня модели OSI, на самом деле он является протоколом сеансового уровня и использует зарегистрированный UDP-порт 1701.  
История:  
- 1996-1997 — конкуренция между протоколами L2F (Cisco) и PPTP (Microsoft)  
- 1997г. — соглашение между разработчиками о совместной разработке протокола L2TP  
- 1999г. — опубликован стандарт RFC 2661, описывающий протокол L2TP  
- 2005г.  
- опубликован стандарт RFC 3931, описывающий версию 3 протокола

L2TPv3 - Протокол L2TP вобрал в себя лучшие черты L2F и PPTP.  
#### Схема работы L2TP  
Задачей протокола L2TP является туннелирование кадров РРР между удаленной системой или клиентом LAC и LNS, размещенном в LAN 

Удаленная система инициирует PPP-соединение с LAC через коммутируемую телефонную сеть PSTN (Public Switched  Telephone Network). LAC затем прокладывает туннель для РРР-соединения через Интернет, Frame Relay или АМ к LNS, и таким образом осуществляется доступ к исходной LAN.  

Адреса удаленной системе предоставляются исходной LAN через согласование с PPP NCP.  
Аутентификация, авторизация и аккаунтинг могут быть предоставлены областью управления LAN, как если бы пользователь был непосредственно соединен с сервером сетевого доступа NAS.

**LAC-клиент** (ЭВМ, которая исполняет программу L2TP) может также участвовать в] туннелировании до исходной LAN без использования отдельного LAC, если ЭВМ, содержащая программу LAC-клиента, уже имеет соединение с Интернет. Создается «виртуальное» РРР-соединение, и локальная программа L2TP LAC формирует туннель до LNS. Как и в вышеописанном случае, адресация, аутентификация, авторизация и аккаунтинг будут обеспечены областью управления исходной LAN.  

*L2TP использует 2 вида пакетов*: управляющие и информационные сообщения.  

Управляющие сообщения используются при установлении, поддержании и аннулировании туннелей и вызовов. 

Информационные сообщения используются для инкапсуляции РРР-кадров, пересылаемых по туннелю. 

Управляющие сообщения используют надежный контрольный канал в пределах L2TP, чтобы гарантировать доставку. Информационные сообщения при потере не пересылаются повторно.

Структура протокола:
- PPP кадры  
- L2TP информационные сообщения  
- L2TP управляющие сообщения  
- L2 ТР информационный канал (ненадежный)
- L2TP канал управления (надежный)  
#### Транспортировка пакетов (UDP, FR, ATM и т.д.)  
Управляющее сообщение имеет порядковый номер, используемый в управляющем канале для обеспечения надежной доставки. Информационные сообщения могут использовать порядковые номера, чтобы восстановить порядок пакетов и детектировать потерю кадров. Все коды посылаются в порядке, принятом для сетей.

![[Бред.jpg]]

- Бит тип (Т) характеризует разновидность пакета. Он устанавливается равным 0 для информационных сообщений и 1  
- для управляющих.  
- Если бит длины (L) равен 11, поле длина присутствует. Для управляющих сообщений этот бит должен быть равен 1.  
- Биты х зарезервированы для будущих применений. Все зарезервированные биты должны быть установлены равными 0 для исходящих сообщений и игнорироваться для входящих.  
- Если бит последовательности (S) равен 1, присутствуют поля Ns и Nr. Бит S для управляющих сообщений должен быть равен 1.  
- Если бит смещения (О) равен 1, поле величины смещения присутствует. Бит О для управляющих сообщений должен быть равен 0.  
- Бит приоритета (Р) д.б. равен 0 для всех управляющих сообщений.  
- ID-сессии определяет идентификатор для сессии данного туннеля. Сессии L2TP именуются с помощью идентификаторов, которые имеют только локальное значение. ID-сессии в каждом сообщении д.б. тем, кот. ожидает получатель. ID-сессии выбираются при формировании сессии.  
- Поле Ns определяет порядковый номер информационного или управляющего сообщения, начиная с нуля и увеличиваясь на 1 (по модулю 216) для каждого посланного сообщения.  
- Поле Nr содержит порядковый номер, кот. ожидается для следующего сообщения. Т.о., Nr делается равным Ns последнего по порядку полученного сообщения плюс 1 (по модулю 216). В информационных сообщениях, Nr зарезервировано и, если присутствует (это определяется S- битом), должно игнорироваться при получении.  
- Поле величина смещения (Offset Size), дели имеется, специфицирует число октетов после заголовка L2TP, где должно начинаться поле данных. Содержимое заполнителя смещения не определено. Если поле смещения присутствует, заголовок L2TP завершается после завершающего октета заполнителя смещения.
#### Управляющее соединение 
Является первичным, которое должно быть реализовано между LAC и LNS перед запуском сессии. Установление управляющего соединения включает в себя безопасную идентификацию партнера, а также определение версии L2TP, возможностей канала, кадрового обмена и т.д.  

L2TP включает в себя простую, опционную, СНАР-подобную систему аутентификации туннеля в процессе установления управляющего соединения.  
#### Установление сессии  
После успешного установления управляющего соединения могут формироваться индивидуальные сессии. Каждая сессия соответствует одному РРР информационному потоку между LAC и LNS. В отличие от установления управляющего соединения, установление сессии является асимметричным в отношении LAC и LNS. LAC запрашивает LNS доступ к сессии для всех, запросов, а LNS запрашивает LAC запустить сессию для работы с исходящими запросами.  

Когда туннель сформирован, РРР-кадры от удаленной системы, получаемые LAC, освобождаются от CRC, канальных заголовков и т. п., инкапсулированных в L2TP, и пере-адресуются через соответствующий туннель. LNS получает L2TP-пакет и обрабатывает инкапсулированный РРР-кадр, как если бы он был получен через локальный интерфейс  
PPP.  

Отправитель сообщения, ассоциированный с определенной сессией и туннелем, помещает ID сессии и туннеля (специфицированные партнером) в соответствующие поля заголовка всех исходящих сообщений.

#### Использование порядковых номеров в канале данных  
Порядковые номера, определенные в заголовке L2TP, используются для организации надежной транспортировки управляющих сообщений. Каждый партнер поддерживает отдельную нумерацию для управляющего соединения и для каждой информационной сессии в пределах туннеля.  

В отличие от канала управления L2TP, информационный канал L2TP использует нумерацию сообщений не для повторной пересылки, а для детектирования потерь пакетов и восстановления исходной последовательности пакетов, перемешанных при транспортировке.  

LNS может инициировать запрет нумерации сообщений в любое время в ходе сессии (включая первое информационное сообщение).  

#### Механизм Keepalive (Hello) (И тебе здарова)  
Механизм Keepalive используется L2TP для того, чтобы различать простои туннеля и длительные периоды отсутствия управления или информационной активности в туннеле. Это делается с помощью управляющих сообщений Hello после заданного периода времени, истекшего с момента последнего получения управляющего сообщения через туннель.

При недоставке сообщения Hello туннель объявляется нерабочим, и система возвращается в исходное состояние. Механизм перевода транспортной среды в исходное состояние путем введения сообщений Hello гарантирует, что разрыв соединения между LNS и  
LAC будет детектирован на обоих концах туннеля.

#### Прерывание сессии  
Прерывание сессии может быть инициировано LAC или LNS и выполняется путем  
посылки управляющего сообщения CDN. После того как последняя сессия прервана, управляющее соединение может быть также разорвано. 

#### Разрыв контрольного соединения  
Разрыв контрольного соединения может быть инициирован LAC или LNS и выполняется путем посылки одного управляющего сообщения StopCCN.  

#### Безопасность  
Протокол L2TP сталкивается при своей работе с несколькими проблемами безопасности. Ниже рассмотрены некоторые подходы для решения этих проблем.  

#### Безопасность на конце туннеля  
Концы туннеля могут опционно выполнять процедуру аутентификации друг друга при установлении туннеля. Эта аутентификация имеет те же атрибуты безопасности, что и СНАР, и обладает разумной защитой против атак воспроизведения и искажения в процесс установления туннеля. Для реализации аутентификации LAC и LNS должны использовать общий секретный ключ.  

#### Безопасность пакетного уровня  
Обеспечение безопасности L2TP требует, чтобы транспортная среда могла обеспечить шифрование передаваемых данных, целостность сообщений и аутентификацию услуг для всего L2TP-трафика. Сам же L2TP ответственен за конфиденциальность, целостность и аутентифицированность L2 TP-пакетов внутри туннеля.

#### L2TP n IPsec  
При работе поверх IP, IPsec (безопасный IP) предоставляет безопасность на пакетном уровне. Все управляющие и информационные пакеты L2 ТР в конкретном туннеле выглядят для системы IPsec как обычные информационные UDP/IP-пакеты. Помимо транспортной безопасности IP, IPsec определяет режим работы, кот. позволяет туннелировать  
IP-пакеты, а также средства контроля доступа, кот. необходимы для приложений, поддерживающих IPsec. Эти средства позволяют фильтровать пакеты на основе характеристик сетевого и транспортного уровней. В модели L2TP-туннеля аналогичная фильтрация выполняется на РРР-уровне или сетевом уровне поверх L2TP.

#### IPsec  
**IPsec (IP Security)** — набор протоколов для обеспечения защиты данных, передаваемых по межсетевому протоколу IP. Позволяет осуществлять подтверждение подлинности (аутентификацию), проверку целостности и шифрование IP-пакетов. IPsec также включает в себя протоколы для защищенного обмена ключами в сети Интернет. В основном, применяется для организации VPN-соединений (шифрование внутри классических VPN-соединений).  

Первоначально сеть Интернет была создана как безопасная среда ПД между военными. Т.к. с ней работал только определенный круг лиц, людей образованных и имеющих представления о политике безопасности, то явной нужды построения защищенных протоколов не было. Безопасность организовывалась на уровне физической изоляции объектов от посторонних лиц, и это было оправдано, когда к сети имело доступ ограниченное число машин. Однако, когда Интернет стал публичным и начал активно развиваться и разрастаться, такая потребность появилась.  

В 1994г. Совет по архитектуре Интернет (IAB) выпустил отчет «Безопасность архитектуры Интернет», кот. был посвящен в основном способам защиты от несанкциониро-ванного мониторинга, подмены пакетов и управлению потоками данных. Требовалась раз-работка некот. стандарта или концепции, способных решить эту проблему. В результате, появились стандарты защищенных протоколов, в т.ч. и IPsec. Первоначально он включал в себя 3 базовые спецификации, описанные в документах (RFC1825, 1826 и 1827), однако впоследствии рабочая группа IP Security Protocol IETF пересмотрела их и предложила новые стандарты (RFC2401-2412), используемые и в настоящее время.

![[ГОВНО.jpg | 500]]

Построение защищенного канала связи может быть реализовано на разных уровнях модели OSI. Например, SSL-протокол работает на сеансовом уровне и уровне представле-ния, а РРТР и L2TP — на сеансовом, IPSec — на сетевом.  
  
В вопросе выбора уровня реализации защищенного канала неск. противоречивых аргументов: с одной стороны, за выбор верхних уровней говорит их независимость от вида транспортировки (выбора протокола сетевого и канального уровней), с др. стороны, для каждого приложения необходима отдельная настройка и конфигурация. Плюсом в выборе нижних уровней является их универсальность и наглядность для приложений, минусом — зависимость от выбора конкретного протокола (например, РР или Ethernet). Компромиссом в выборе уровня является IPsec: он располагается на сетевом уровне, используя самый распространенный протокол этого уровня — ІР. Это делает IPsec более гибким,  
так что он может использоваться для защиты любых протоколов, базирующихся на ТСР и UDP. В то же время, он прозрачен для большинства приложений.  
  
IPsec является набором стандартов Интернета и своего рода надстройкой над IP-протоколом. Его ядро составляют 3 протокола:

- **Authentication Header** (AH) обеспечивает целостность передаваемых данных, аутентификацию источника информации и функцию по предотвращению повторной передачи пакетов  
- **Encapsulating Security Payload** (ESP) обеспечивает конфиденциальность (шифрование) передаваемой информации, ограничение потока конфиденциального трафика. Кроме этого, он может исполнять функции АН: обеспечить целостность передаваемых данных, аутентификацию источника информации и функцию по предотвращению повторной передачи пакетов. При применении ESP в обязательном порядке должен указываться набор услуг по обеспечению безопасности: каждая из его функций может включаться опционально.  

**Internet Security Association and Key Management Protocol** (ISAKMP) — протокол, ис-  
пользуемый для первичной настройки соединения, взаимной аутентификации конечными узлами друг друга и обмена секретными ключами. Протокол предусматривает использование различных механизмов обмена ключами, включая задание фиксированных ключей, использование таких протоколов, как Internet Key Exchange, Kerberized  
Internet Negotiation of Keys (RFC 4430) или записей DNS типа IPSECKEY (RFC 4025).

Также одним из ключевых понятий является Security Association (SA). По сути, SA является набором параметров, характеризующим соединение. Например, используемые алгоритм шифрования и хэш-функция, секретные ключи, номер пакета и др.

*IPsec может функционировать в 2 режимах*: транспортный и туннельный.  
В транспортном режиме шифруются (или подписываются) только данные IP-пакета, исходный заголовок сохраняется. Транспортный режим, как правило, используется для установления соединения между хостами. Он может также использоваться между шлюзами для защиты туннелей, организованных каким-н. др. способом (например, L2TP).  

В туннельном режиме шифруется весь исходный IP-пакет: данные, заголовок, маршрутная информация, а затем он вставляется в поле данных нового пакета, то есть происходит инкапсуляция. Туннельный режим может использоваться для подключения удалённых компьютеров к виртуальной частной сети или для организации безопасной передачи данных через открытые каналы связи (например, Интернет) между шлюзами для объединения разных частей виртуальной частной сети.  

Режимы IPsec не являются взаимоисключающими. На одном и том же узле некоторые SA могут использовать транспортный режим, а др. — туннельный.

#### Security Association 
Для начала обмена данными между двумя сторонами необходимо установить соединение, которое носит название SA (Security Association). Концепция SA фундаментальна для IPsec, собственно, является его сутью. Она описывает, как стороны будут использовать сервисы для обеспечения защищённого общения. Соединение SA является симплексным (однонаправленным), поэтому для взаимодействия сторон необходимо установить два соединения. Стоит также отметить, что стандарты IPsec позволяют конечным точкам  
защищенного канала использовать как одно SA для передачи трафика всех взаимодействующих через этот канал хостов, так и создавать для этой цели произвольное число безопасных ассоциаций, например, по одной на каждое ТСР-соединение. Это дает возможность выбирать нужную степень детализации защиты. Установка соединения начинается с взаимной аутентификации сторон. Далее происходит выбор параметров (будет ли осуществляться аутентификация, шифрование, проверка целостности данных) и необходимого протокола (АН или ESP) передачи данных. После этого выбираются конкретные алгоритмы (например, шифрования, хэш-функция) из нескольких возможных схем, некоторые из которых определены стандартом (для шифрования — DES, для хэш-функций — MD5 или SHA-1), др. добавляются производителями продуктов, использующих IPsec (например, Triple DES, Blowfish, CAST и др.).

#### Security Associations Database  
Все SA хранятся в базе данных SAD (Security Associations Database) IPsec-модуля.  
Каждое SA имеет уникальный маркер, состоящий из 3 элементов:  
- Индекс параметров безопасности (Security Parameters Index, SPI)  
- IP-адрес назначения  
- Идентификатор протокола безопасности (ESP или АН)  

IPsec-модуль, имея эти 3 параметра, может отыскать в SAD запись о конкретном SA.  
В список компонентов SA входят:  
- *Последовательный номер* (32-битовое значение, которое используется для формирования поля Sequence Number в заголовках АН и ESP).  
- *Переполнение счетчика* порядкового номера флаг, который сигнализирует о переполнении счетчика последовательного номера.  
- *Окно для подавления атак* воспроизведения используется для определения повторной передачи пакетов. Если значение в поле Sequence Number не попадает в заданный диапазон, то пакет уничтожается.  
- *Информация АН*  (используемый алгоритм аутентификации, необходимые ключи, время жизни ключей и др. параметры).  
- *Информация ESP* (алгоритмы шифрования и аутентификации, необходимые ключи, параметры инициализации, время жизни ключей и другие параметры)
- *Режим работы IPsec* (туннельный или транспортный)
- *Время жизни SA*  (задано в секундах или байтах информации, проходящих через туннель. Определяет длительность существования SA, при достижении этого значения текущее SA должно завершиться, при необходимости продолжить соединение устанавливается новое SA).

---

Next door: [[АС ЭВМ - Лекция 9]]
