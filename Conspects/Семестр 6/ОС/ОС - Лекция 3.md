#### Ядро ОС. Мультипрограммирование

*Понятие ядра ОС* - одновременно строгое техническое определение и невозможное в абсолютной точности понятие, условно понятное специалистам.

**Ядро ОС** - та часть программного обеспечения, которая определяет свойства конкретной ОС / часть ОС, постоянно находящаяся в оперативной памяти. 

- Ядро постоянно доступно ЦП для выполнения (только код в оперативной памяти может выполняться современными ОС) - в памяти находится определенный код, который обеспечивает загрузку

- Возможно сделать систему, считывающую данные напрямую с диска, но это будет скорее частным случаем. Без поддержки файловой системы ОС должна уметь работать безусловно с какой-либо из них.

- Включает компоненты ОС, критически влияющие на быстродействие вычислительной системы:

- Диспетчер процессов
- Подсистема реального времени
- Поддержка файловой системы
- Система менеджера ОС
- Включает компоненты ОС, критически важные для нормального функционирования вычислительной системы

---
##### Назначение и функции

- Управление процессами

- Создание и уничтожение
- Диспетчирование
- Переходы между состояниями
- Синхронизация (синхронизировать процессы можно по-разному, в том числе без привлечения функций ОС, однако такой функционал все же существует, поэтому у программиста появляется выбор)

- Управление ресурсами вычислительной системы (например, менеджер оперативной памятью)
- Поддержка операций ввода-вывода
- Обработка внешних событий (прерываний в системе)
- Учет времени (есть 2 принципиально разные задачи: подсчет реального времени: знание реальных даты и времени; и учет временных интервалов: тут не важно знать само реальное время - сравнительно с таймером)

**!Полезно знать:** в ОС Linux существует 3 метода доступа к реальному времени (обычно более часто из них используют 2). Один из них - МЕТКА: хранит не время создания не самого файла, а E-узла. Такие метки можно получить только в случае, если файловая система ведет учет реального времени, что, как правило, происходит всегда.

**!Полезно знать:** протокол, устанавливающий синхронизацию реального времени по сети - NTP.

---
##### Классификация

- *Монолитные* - ранние версии Linux, версии Windows (не на базе NT) Код ядра - один большой файл, включающий в себя все компоненты и драйверы. Большая скорость работы, меньшая надежность (из-за одной ошибки может упасть все ядро). При необходимости добавить / удалить драйвер требуется полная перекомпиляция, или, по крайней мере, перезагрузка ОС.

- *Модульные* - современные версии Linux (+ ряд других менее известных opensource ОС): при добавлении устройств можно добавить необходимые драйвера, а при отключении - выгрузить для освобождения места для других устройств. Все ядро разделяется на монолитную часть (содержит самые необходимые для работы компоненты и драйверы) и компоненты (могут динамически загружаться и разгружаться в процессе работы ОС). При необходимости добавления нового драйвера не требуется наличие полного комплекта исходных кодов ядра и обычно не требуется перекомпиляция всего ядра.

- *Микроядерные* - QNX, Hurd, Windows NT, macOS (общая идея в том, что в ядре ОС, работающем в режиме супервизора находится минимум служб, без которых ядро не может существовать, остальные службы вынесены в серверы, которые выполняются в пространстве пользователя: поддержка файловой системы, контроль оперативной памяти… между собой они взаимодействуют посылкой сообщений через ядро).

**FSF** - фонд, который поставил перед собой задачу выпускать свободные версии ПО, которые копируют Unix (было повторено практически все, кроме ядра). Ричард Толдман считал, что ядро должно быть только микроядерным. Ядро Hurd находится в стадии бета-разработки около 40 лет.

**Анекдот от Шефа:** зачем на системных блоках компьютеров делают кнопку Reset? Потому что на них устанавливают ОС Windows.

---
##### Иерархический способ построения ядра ОС

Уровни наслаиваются от центра до внешних слоев.
**В центре:** Аппаратура

1. Диспетчера
2. Управление вводом-выводом
3. Управление файлами
4. Прикладные программы

- Иерархическое ядро предполагает наличие интерфейсов между уровнями, тогда каждым уровнем может заниматься отдельная команда разработчиков - приводит у уменьшению времени разработки.

- Считается, что процесс, находящийся на определенном уровне, может передавать управление процессам, находящимся на более высоких в иерархии уровнях, либо отправить запрос к диспетчеру, который может передать управлению процессу на более низких уровнях.

Для работы нескольких ОС на одной аппаратуре (виртуальные машины) предполагается обязательное наличие Монитора виртуальной машины (МВМ) - процессы на надстраиваемых ОС видят процессы главной ОС, и чтобы разграничить процессы, используется тот самый МВМ.

Ядро ОС считает, что оно работает в привелегированном режиме, но ему разрешают выполнять привелегированные процессы, которые по факту перехватываются и не выполняются, но для ОС создается видимость, что процесс выполняется.

---
##### Диспетчеризация процессов

- Определение длительности времени ЦП, предоставленного процессору
- Сохранение и восстановление контекста процесса
- Выбор очередного процесса, которому будет предоставлено время ЦП

*Режимы разделения времени (оперативного доступа):*
- Пакетный режим
- Режим разделения времени

*Режимы выполнения кода:*
- Режим пользователя
- Режим супервизора

*Системные вызовы предоставляют прикладным программам различные сервисы ядра ОС:*
- Выделение о освобождение ресурсов вычислительной системы
- Взаимодействие с различными периферийными устройствами
- Доступ к файловой системе
- Синхронизация работы асинхронных процессов
- Служба времени
- Порождение удаление дочерних процессов

---

Next door: [[ОС - Лекция 4]]